
# Honeywell PHD 数据压缩与分类存储机制整理

> 本文整理自 Honeywell Uniformance PHD User Guide（R310），
> 目的在于总结其**数据压缩算法思想**与**分类/分层存储体系**，
> 用于设计工业时序数据库（如 xTdb）时的架构参考。
>
> **说明**：本文仅描述公开的工程思想与机制，不涉及任何专有实现细节或代码。

---

## 1. PHD 的核心数据哲学

PHD 并不将历史数据视为“等间隔采样点集合”，
而是将其抽象为：

> **在时间轴上由若干线性段（piecewise linear segments）组成的连续信号**

每个线性段具有：
- 起止时间
- 起止值
- 有效持续区间
- 质量/置信信息（0–100）

任意时刻的值，都可以通过所在区间的线性插值得到。

这一哲学直接决定了 PHD 的压缩、插值、聚合与存储方式。

---

## 2. 点消除压缩（Constrained Slope / Swinging Door 类算法）

### 2.1 基本思想

PHD 采用一种**受限斜率（Constrained Slope）**的数据压缩方法，
属于工业领域常见的 *Swinging Door Algorithm* 算法家族。

核心目标：

> **在保证数值误差不超过工程容差的前提下，
> 尽可能减少需要存储的数据点数量。**

---

### 2.2 压缩判定逻辑（概念级）

对于一个 Tag：

1. 定义工程容差 `Tolerance`
2. 实际压缩容差：
   ```
   CompressionTolerance = Tolerance × CompressionFactor
   ```

3. 从最近一次已存储点 `(t0, v0)` 出发：
   - 构造允许的最大斜率与最小斜率边界
   - 形成一个“斜率包络（slope envelope）”

4. 新到达点 `(t1, v1)`：
   - 若仍落在允许的斜率包络内 → **不存**
   - 若超出包络 → **固化前一线性段并存点**

5. 存储的并不是所有采样点，而是：
   - 线性段的关键端点

---

### 2.3 算法特性

- 按 **Tag / Class Tag** 配置（非全局）
- 支持不同工程量不同容差
- 对平稳过程变量（PV）压缩比极高
- 保证任意时间点可通过插值重建，误差有上界

---

## 3. 写入前处理（Pre‑Processing）

PHD 的压缩并非纯“存储层行为”，
而是在写入路径中引入了可配置的数据预处理。

### 3.1 常见预处理类型

- **Gross Error Detection**
  - 基于邻域统计与标准差的毛刺剔除
- **指数平滑（Exponential Smoothing）**
- **Gating / Deadband**
  - 微小变化直接抑制为 0

### 3.2 工程意义

- 降低噪声 → 提高压缩率
- 提高统计/报表结果的稳定性
- 属于 *Ingestion Policy*，可按 Tag 配置

---

## 4. 数值量化存储（16-bit Quantization）

### 4.1 基本机制

对于浮点数值：

- 为 Tag 配置 Low / High Extreme
- 在该范围内将数值线性映射为 16-bit 整数
- 在量程内相对精度约 **0.0015%**

### 4.2 特点

- 大幅降低存储体积
- 适用于有明确工程量程的工业数据
- 超量程需要额外策略（裁剪 / 扩容 / 回退）

---

## 5. 分类与分层存储（Archive Architecture）

### 5.1 按数据类型分类的 Archive

PHD 在逻辑上区分不同类型的历史数据：

- **SCAN Archive**
  - 连续数值数据（PV、MV 等）
- **CHAR Archive**
  - 字符串 / 二进制 / Unicode 数据
- **MANV Archive**
  - 人工录入数据（实验室数据、化验结果等）

不同 Archive 拥有独立的存储策略与生命周期。

---

### 5.2 多分辨率 / 多层 Archive

PHD 支持：

- 多个 Archive 覆盖**重叠的时间范围**
- 不同 Archive 具有不同分辨率（高频 / 低频）
- 查询时：
  > **优先使用分辨率更高的 Archive**

典型结构：

- 高分辨率短期 Archive（秒级/毫秒级）
- 中期降采样 Archive（分钟级）
- 长期统计 Archive（小时/天级）

---

### 5.3 重采样存储（Resampled Archive）

- 可将高频数据按固定周期重采样
- 重采样结果写入独立 Archive
- 用于降低长期在线存储成本

---

## 6. 质量与置信度（Quality / Confidence）

PHD 为每个线性段与数据区间维护置信信息：

- 表示该区间内数据的可信程度
- 在缺测、插值、降采样时动态调整

在聚合计算（avg / min / max / regression）中：

- 按有效覆盖比例与质量加权

---

## 7. 对工业时序数据库设计的启示

PHD 的设计可抽象为以下几条原则：

1. **逻辑模型先于物理存储**
2. **压缩是线性段，而不是点**
3. **工程容差是压缩的核心参数**
4. **多分辨率是长期存储的必然选择**
5. **质量信息必须参与计算语义**

这些原则可以作为 xTdb 等系统未来增强能力的参考基础。

---

## 8. 适用于 xTdb 的“兼容性总结”

PHD 的这些机制表明：

- 压缩算法可作为可插拔策略
- 分类存储与多层 Archive 可渐进引入
- 只要逻辑接口稳定，物理实现可演进

这为“先做可用版本，再逐步增强能力”的架构路线提供了现实范例。

---

*End of Document*


# Honeywell Uniformance PHD 数据库存储与压缩技术白皮书

## 1. 概述
Honeywell Uniformance® PHD (Process History Database) 是工业界领先的实时数据库系统。与传统基于离散采样点的数据库不同，PHD 的设计哲学基于**连续过程理论**。它将时间序列数据视为一系列连续的线性段 (Linear Segments)，而非孤立的数据点。这种设计使其在保持极高数据还原度的同时，实现了惊人的存储压缩率。

本文档详细拆解了 PHD 的两大核心技术支柱：**数据压缩算法**与**分层归档存储架构**，供 `xTdb` 系统设计参考。

---

## 2. 数据压缩技术 (Data Compression)

PHD 采用多级压缩策略，从数据采集端到磁盘落盘，层层过滤冗余信息。

### 2.1 旋转门压缩算法 (Constrained Slope / Swinging Door)
这是 PHD 最核心的“死区与斜率”压缩算法，用于消除线性趋势上的冗余点。

* **基本原理**：
    系统不存储所有采集到的点，而是存储能够构建出“原始趋势线”的关键拐点。系统认为在一定误差范围内，点与点之间是线性的。
    
* **算法流程**：
    1.  **建立起点**：从上一个已存储的点开始。
    2.  **构建容差带 (Tolerance Band)**：基于配置的 `Compression Tolerance`（压缩偏差），在当前趋势线的上下构建一个平行四边形的“门”。
    3.  **判定新点**：
        * 连接起点与新采集的点。
        * 检查中间所有的点是否都落在起点的“张角”范围内。
        * 只要新数据点导致斜率变化在容差带内（即“门”没有被撑开），该点就被认为是冗余的，**暂不存储**（仅在内存中更新“末端点”）。
    4.  **异常存储 (Exception Storage)**：
        * 一旦接收到一个新值，导致斜率超出了容差带（即“门”被撑开或无法继续延伸），系统判定趋势发生改变。
        * **动作**：系统会存储**导致偏差的前一个有效点**（作为旧线段的终点）以及**当前的新点**（作为新线段的起点）。
    
* **配置参数**：
    * `Tolerance` (基本偏差)：物理量的绝对值（如 0.5 度）。
    * `Compression Tolerance Factor` (压缩因子)：用于动态调整偏差带宽。

### 2.2 数据量化与缩放 (Quantizing & Scaling)
针对浮点数存储的极致优化，利用工业数据的物理范围特性来减少存储位宽。

* **原理**：
    大多数传感器数据（如温度、压力）的物理范围是固定的（例如 0~100℃）。PHD 利用这一特性，将 32位/64位 浮点数映射为 **16位整数 (Int16)** 进行存储。
* **实现方式**：
    * 设定 `High Extreme`（高限）和 `Low Extreme`（低限）。
    * 数据落盘时：$StoredValue = \frac{(ActualValue - Low)}{(High - Low)} \times 65535$
    * 数据读取时：反向计算还原为浮点数。
* **效果**：
    * 存储空间直接减少 50%~75%。
    * 精度损失控制在 0.0015% 以内（对于工业趋势分析通常可忽略）。

### 2.3 统计性误差剔除 (Statistical Gross Error Elimination)
* **功能**：在压缩前进行预处理，剔除明显的噪声或传感器故障值。
* **逻辑**：基于标准差（Standard Deviation）阈值，如果某个点瞬间跳变超过 $N$ 倍标准差，则被视为“野点”直接丢弃，不进入压缩管道。

---

## 3. 分层归档存储架构 (Tiered Archive System)

PHD 的存储引擎设计非常独特，它不支持“分片 (Sharding)”，而是采用**时间重叠的分层文件系统**。

### 3.1 逻辑归档类型 (Logical Archives)
PHD 根据数据类型将数据分流到不同的物理文件中，以优化读写性能：

| 归档类型 | 包含数据内容 | 特点 |
| :--- | :--- | :--- |
| **SCAN Archives** | 连续采集量 (Float, Int) | 写入频率极高，采用上述压缩算法，查询最频繁。 |
| **CHAR Archives** | 离散状态量 (String, Blob) | 存储文本、操作日志、事件。不进行斜率压缩，通常采用 RLE 或 Delta 压缩。 |
| **MANV Archives** | 人工录入值 (Manual Input) | 极度稀疏，数据极其重要。独立存储以防被高频数据的大量写入操作覆盖或冲刷。 |

### 3.2 多层与重采样 (Multi-Layer & Resampling)
这是 PHD 解决“长周期历史数据膨胀”的关键机制。

* **重叠时间窗口 (Overlapping Time Ranges)**：
    PHD 允许不同精度的归档文件在时间轴上重叠。例如，你可以同时拥有：
    * **Layer 1 (Raw)**: 最近 3 个月的原始高频数据（1秒级）。
    * **Layer 2 (Resampled)**: 最近 5 年的重采样数据（1分钟级）。

* **查询透明化**：
    当用户发起查询时，API 会自动判断请求的时间范围：
    * 如果查最近 1 小时，系统读取 Layer 1 的高精数据。
    * 如果查 3 年前的趋势，系统自动切换读取 Layer 2。
    * **优势**：上层应用无需关心数据到底存在哪，且查询长周期数据速度极快（IO 开销小）。

---

## 4. 数据质量模型 (Data Confidence)

PHD 不仅仅存储“数值”，它为每一个数据点附加了**质量属性**。

* **信心系数 (Confidence Factor)**：
    * 范围：0 ~ 100。
    * **100**：原始采集的真实数据。
    * **< 100**：插值生成的数据、或者采集链路报告信号不稳定的数据。
    * **0**：通信中断或传感器故障期间的数据。
* **加权聚合**：
    在计算平均值 (AVG) 时，PHD 不是简单地 $\frac{\sum x}{n}$，而是使用信心系数进行加权。如果某段时间数据质量差，它对最终平均值的贡献权重就会降低，从而保证计算结果的真实可信。

---

## 5. 对 xTdb 设计的参考建议

1.  **Block Header 预留**：在设计底层文件格式时，务必在 Block Header 中预留 `EncodingType` 字段，以便未来无缝引入 Swing Door 压缩或 Int16 量化压缩，与现有的 Gorilla/XOR 压缩共存。
2.  **Schema 扩展性**：在元数据存储中增加 `Attributes` 字段，用于存储每个测点的 `CompressionDev` (压缩偏差) 和 `High/Low Limit` (物理量程)，这是实现高压缩比的基础。
3.  **读写分离的插值层**：不要让查询层直接吐出磁盘上的稀疏点。必须实现一个 `Iterator` 包装层，根据查询请求（Raw vs Interpolated），在内存中实时还原线性段。

---
*文档生成时间：2026-01-07*
*参考来源：Honeywell Uniformance PHD User Guide R310*