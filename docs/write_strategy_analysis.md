# xTdb å†™ç›˜ç­–ç•¥åˆ†æ

## å½“å‰å†™ç›˜æ¶æ„

### 1. åŒå†™æœºåˆ¶ (WAL + å†…å­˜ç¼“å†²)

```
å†™å…¥è·¯å¾„:
  ç”¨æˆ· writePoint()
    â†“
  â‘  WAL å†™å…¥ (24 å­—èŠ‚/ç‚¹)
    â†“
  â‘¡ å†…å­˜ç¼“å†² (12 å­—èŠ‚/ç‚¹)
    â†“
  â‘¢ æ¡ä»¶åˆ·ç›˜ (1000 ç‚¹/tag)
```

### 2. WAL (Write-Ahead Log) ç­–ç•¥

**é…ç½®**:
- WAL åŒºåŸŸå¤§å°: 4 MB (256 extents)
- WAL buffer: 16 KB (1ä¸ª extent)
- æ¡ç›®å¤§å°: 24 å­—èŠ‚/ç‚¹

**å†™å…¥è§¦å‘**:
- append(): å†™å…¥ buffer (å†…å­˜)
- buffer æ»¡ (16KB): flush buffer â†’ ç£ç›˜ (16KB å¯¹é½å†™å…¥)
- æ¯ 1000 æ¡: sync() (fsync è°ƒç”¨)

**WAL Entry ç»“æ„** (24 å­—èŠ‚):
```cpp
struct WALEntry {
    uint32_t tag_id;           // 4B
    int64_t timestamp_us;      // 8B
    uint8_t value_type;        // 1B
    uint8_t quality;           // 1B
    uint16_t reserved;         // 2B (padding)
    union {                    // 8B
        double f64_value;
        // ... other types
    } value;
};  // Total: 24 bytes
```

### 3. å†…å­˜ç¼“å†²ç­–ç•¥

**é…ç½®**:
- æ¯ä¸ª tag ç‹¬ç«‹ç¼“å†²: `std::unordered_map<tag_id, TagBuffer>`
- åˆ·ç›˜é˜ˆå€¼: 1000 æ¡/tag
- MemRecord å¤§å°: 12 å­—èŠ‚/ç‚¹

**MemRecord ç»“æ„** (12 å­—èŠ‚):
```cpp
struct MemRecord {
    uint32_t time_offset;  // 4B (ç›¸å¯¹æ—¶é—´)
    uint8_t quality;       // 1B
    // 3B padding
    union {                // 8B
        double f64_value;
    } value;
};  // Total: 12 bytes (å®é™…å ç”¨å› å¯¹é½å¯èƒ½ä¸º 16B)
```

**åˆ·ç›˜è§¦å‘**:
- æŸä¸ª tag è¾¾åˆ° 1000 æ¡
- æ‰‹åŠ¨è°ƒç”¨ flush()
- å…³é—­å¼•æ“

### 4. ç£ç›˜åˆ·å†™ (flush) ç­–ç•¥

**è¡Œä¸º**:
- éå†æ‰€æœ‰ tag ç¼“å†²åŒº
- æ¯ä¸ª tag å†™æˆä¸€ä¸ªæ•°æ®å— (16KB)
- æ›´æ–°ç›®å½• (directory)
- æ¸…ç©ºå†…å­˜ç¼“å†²
- **æ¸…ç©º WAL** (reset + é¦–ä¸ª extent æ¸…é›¶)

---

## åœºæ™¯åˆ†æ: 10ä¸‡ tag Ã— 1ç‚¹/ç§’

### è¾“å…¥å‚æ•°
- Tag æ•°é‡: 100,000
- å†™å…¥é¢‘ç‡: 1 ç‚¹/ç§’/tag
- æ€»ååé‡: **100,000 ç‚¹/ç§’**

### 1. WAL å†™å…¥é‡

**æ¯ç§’**:
- WAL æ¡ç›®: 100,000 Ã— 24B = **2.4 MB/ç§’**
- WAL buffer åˆ·ç›˜æ¬¡æ•°: 2,400,000 / 16,384 = **~147 æ¬¡/ç§’**
- fsync è°ƒç”¨: 100,000 / 1,000 = **100 æ¬¡/ç§’**

**æ³¨æ„**: WAL åŒºåŸŸåªæœ‰ 4MBï¼Œä¼šåœ¨ 1.67 ç§’åå†™æ»¡ï¼
```
4 MB / 2.4 MB/s = 1.67 ç§’
```

**é—®é¢˜**: WAL ä¼šé¢‘ç¹è§¦å‘ reset()ï¼Œå¯èƒ½å¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚

### 2. å†…å­˜ç¼“å†²å¢é•¿

**æ¯ç§’**:
- å†…å­˜å¢é•¿: 100,000 Ã— 12B = **1.2 MB/ç§’**
- æ´»è·ƒ tag buffers: 100,000 ä¸ª
- å†…å­˜å ç”¨: 100,000 Ã— (sizeof(TagBuffer) + 12B) â‰ˆ **10-15 MB/ç§’**

**1000 ç§’å** (16åˆ†40ç§’):
- æ¯ä¸ª tag ç§¯ç´¯ 1000 ç‚¹
- æ€»å†…å­˜å ç”¨: ~**10-15 GB**
- è§¦å‘ flush(): æ‰€æœ‰ tag åŒæ—¶åˆ·ç›˜

### 3. ç£ç›˜åˆ·å†™è¡Œä¸º

**è§¦å‘æ—¶æœº** (æœ€åæƒ…å†µ):
- 1000 ç§’åï¼Œæ‰€æœ‰ 100,000 ä¸ª tag åŒæ—¶è¾¾åˆ° 1000 æ¡é˜ˆå€¼
- flush() ä¸€æ¬¡æ€§å†™å…¥æ‰€æœ‰ tag

**å†™å…¥é‡**:
```
100,000 tags Ã— 16 KB/block = 1.6 GB
```

**å†™å…¥æ—¶é—´** (å‡è®¾ 500 MB/s ç£ç›˜):
```
1.6 GB / 500 MB/s = 3.2 ç§’
```

**ç›®å½•æ›´æ–°**:
```
100,000 directory entries Ã— ~64B = 6.4 MB
```

### 4. æ€»ä½“å†™ç›˜è´Ÿè½½

**æŒç»­è´Ÿè½½** (å‰ 1000 ç§’):
- WAL å†™å…¥: **2.4 MB/ç§’** (æŒç»­)
- fsync: **100 æ¬¡/ç§’** (é«˜å¼€é”€)
- ç£ç›˜åˆ·å†™: **0 MB/ç§’** (æœªè§¦å‘)

**çªå‘è´Ÿè½½** (1000 ç§’æ—¶):
- æ•°æ®å—å†™å…¥: **1.6 GB** (3.2 ç§’çªå‘)
- ç›®å½•æ›´æ–°: **6.4 MB**
- WAL æ¸…ç©º: **256 KB** (é¦–ä¸ª extent)

---

## æ€§èƒ½ç“¶é¢ˆåˆ†æ

### ğŸ”´ ä¸¥é‡é—®é¢˜

#### 1. WAL å®¹é‡ä¸è¶³
- å½“å‰: 4 MB
- éœ€æ±‚: 2.4 MB/ç§’
- **1.67 ç§’å WAL å†™æ»¡ï¼Œç³»ç»Ÿè¿”å› ERROR_FULL**

#### 2. é›ªå´©å¼åˆ·ç›˜
- 100,000 ä¸ª tag åŒæ—¶è¾¾åˆ° 1000 æ¡é˜ˆå€¼
- 3.2 ç§’å†…å†™å…¥ 1.6 GB
- æœŸé—´æ‰€æœ‰å†™å…¥è¢«é˜»å¡ (åŒæ­¥ flush)

#### 3. fsync é£æš´
- 100 æ¬¡/ç§’ fsync
- æ¯æ¬¡ fsync ~5-10ms (æœºæ¢°ç›˜æ›´é«˜)
- **æ€»å»¶è¿Ÿ: 500-1000 ms/ç§’ = 50-100% CPU æ—¶é—´**

### ğŸŸ¡ æ¬¡è¦é—®é¢˜

#### 4. å†…å­˜å ç”¨é«˜
- 10-15 GB å†…å­˜ (1000 ç§’å)
- 100,000 ä¸ª TagBuffer å¯¹è±¡

#### 5. flush() éå†æ‰€æœ‰ tag
- O(100,000) å¤æ‚åº¦
- å³ä½¿åªæœ‰ 1 ä¸ª tag éœ€è¦åˆ·ç›˜

---

## ä¼˜åŒ–å»ºè®®

### çŸ­æœŸä¼˜åŒ– (ç«‹å³å¯è¡Œ)

#### 1. å¢å¤§ WAL å®¹é‡
```cpp
// ä» 4 MB å¢åŠ åˆ° 64 MB
uint64_t wal_size = 4096 * kExtentSizeBytes;  // 64 MB
```
- å¯æ”¯æŒ 26.7 ç§’è¿ç»­å†™å…¥
- ä»éœ€é…åˆå…¶ä»–ä¼˜åŒ–

#### 2. è°ƒæ•´ fsync é¢‘ç‡
```cpp
// ä» 1000 æ¡å¢åŠ åˆ° 10,000 æ¡
if (wal_entries_since_sync_ >= 10000) {
    wal_writer_->sync();
    wal_entries_since_sync_ = 0;
}
```
- fsync é™ä½åˆ° 10 æ¬¡/ç§’
- å´©æºƒé£é™©: æœ€å¤šä¸¢å¤± 10,000 æ¡ (0.1 ç§’æ•°æ®)

#### 3. æŒ‰ tag åˆ†æ‰¹åˆ·ç›˜
```cpp
// flush() ä¸­åªåˆ·å†™è¾¾åˆ°é˜ˆå€¼çš„ tag
if (tag_buffer.records.size() >= 1000) {
    flushSingleTag(tag_id);  // å• tag åˆ·å†™
}
```
- é¿å…é›ªå´©
- åˆ†æ•£å†™å…¥è´Ÿè½½

### ä¸­æœŸä¼˜åŒ– (éœ€é‡æ„)

#### 4. å¼‚æ­¥åˆ·ç›˜çº¿ç¨‹æ± 
```cpp
// åå°çº¿ç¨‹æ± å¤„ç†åˆ·ç›˜
void writePoint(...) {
    if (tag_buffer.records.size() >= 1000) {
        thread_pool_->submit([this, tag_id]() {
            flushSingleTag(tag_id);
        });
    }
}
```
- å†™å…¥ä¸è¢«é˜»å¡
- éœ€è¦é”æœºåˆ¶ä¿æŠ¤

#### 5. åˆ†åŒº WAL
```cpp
// æ¯ N ä¸ª tag ä¸€ä¸ª WAL åŒºåŸŸ
std::vector<WALWriter> wal_partitions_;  // ä¾‹å¦‚ 10 ä¸ªåˆ†åŒº
int partition = tag_id % num_partitions;
wal_partitions_[partition]->append(entry);
```
- é™ä½å•ä¸ª WAL å‹åŠ›
- fsync åˆ†æ•£

#### 6. æ‰¹é‡ fsync
```cpp
// å®šæ—¶å™¨è§¦å‘ (ä¾‹å¦‚æ¯ 100ms)
void periodicSync() {
    for (auto& wal : wal_partitions_) {
        wal->sync();
    }
}
```
- é™ä½ fsync é¢‘ç‡
- æé«˜ååé‡

### é•¿æœŸä¼˜åŒ– (æ¶æ„çº§)

#### 7. æ— é”ç¯å½¢ç¼“å†²åŒº
- æ›¿ä»£ std::unordered_map
- é™ä½é”ç«äº‰

#### 8. ç›´æ¥ I/O (O_DIRECT)
- ç»•è¿‡é¡µç¼“å­˜
- é™ä½å†…å­˜å‹åŠ›

#### 9. å‹ç¼©å†™å…¥
- WAL ä½¿ç”¨è½»é‡å‹ç¼© (å¦‚ LZ4)
- é™ä½ I/O é‡

---

## æ¨èé…ç½® (100K tag Ã— 1ç‚¹/ç§’)

### é…ç½® A: å¹³è¡¡å‹
```cpp
WAL å¤§å°: 64 MB
WAL fsync: æ¯ 5,000 æ¡ (20 æ¬¡/ç§’)
åˆ·ç›˜é˜ˆå€¼: 1,000 æ¡/tag
å¼‚æ­¥åˆ·ç›˜: 4 çº¿ç¨‹æ± 
```
**æ€§èƒ½**:
- WAL æŒç»­ 26 ç§’
- ç£ç›˜å†™å…¥: ~10 MB/ç§’ (åˆ†æ•£)
- å´©æºƒä¸¢å¤±: <0.05 ç§’æ•°æ®

### é…ç½® B: é«˜ååå‹
```cpp
WAL å¤§å°: 256 MB (åˆ† 16 ä¸ªåˆ†åŒº)
WAL fsync: æ¯ 10,000 æ¡ (10 æ¬¡/ç§’)
åˆ·ç›˜é˜ˆå€¼: 5,000 æ¡/tag
å¼‚æ­¥åˆ·ç›˜: 16 çº¿ç¨‹æ± 
```
**æ€§èƒ½**:
- WAL æŒç»­ 107 ç§’
- ç£ç›˜å†™å…¥: ~50 MB/ç§’ (æ‰¹é‡)
- å´©æºƒä¸¢å¤±: <0.1 ç§’æ•°æ®

### é…ç½® C: ä½å»¶è¿Ÿå‹
```cpp
WAL å¤§å°: 128 MB (åˆ† 8 ä¸ªåˆ†åŒº)
WAL fsync: æ¯ 1,000 æ¡ (100 æ¬¡/ç§’ï¼Œä½†åˆ†åŒºåˆ†æ•£)
åˆ·ç›˜é˜ˆå€¼: 500 æ¡/tag (æ›´é¢‘ç¹ä½†å°æ‰¹é‡)
å¼‚æ­¥åˆ·ç›˜: 8 çº¿ç¨‹æ± 
```
**æ€§èƒ½**:
- WAL æŒç»­ 53 ç§’
- ç£ç›˜å†™å…¥: ~5 MB/ç§’ (å¹³æ»‘)
- å´©æºƒä¸¢å¤±: <0.01 ç§’æ•°æ®

---

## æµ‹è¯•å»ºè®®

### å‹åŠ›æµ‹è¯•åœºæ™¯
```bash
# åœºæ™¯ 1: 10 ä¸‡ tag Ã— 1 ç‚¹/ç§’ (æŒç»­ 1 å°æ—¶)
# åœºæ™¯ 2: 1 ä¸‡ tag Ã— 10 ç‚¹/ç§’ (é«˜é¢‘å†™å…¥)
# åœºæ™¯ 3: 100 ä¸‡ tag Ã— 0.1 ç‚¹/ç§’ (æµ·é‡ tag)
```

### ç›‘æ§æŒ‡æ ‡
- WAL ä½¿ç”¨ç‡ (%)
- fsync å»¶è¿Ÿ (ms)
- ç£ç›˜ IOPS / å¸¦å®½
- å†…å­˜å ç”¨
- å†™å…¥å»¶è¿Ÿ P99
